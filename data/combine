import os
import rasterio
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image

def find_band_paths(cropped_folder, year):
    band_paths = []
    valid_band_suffixes = ["B02", "B03", "B04"] ## , "B08"

    for filename in os.listdir(cropped_folder):
        if filename.endswith("_10m.jp2") and any(suffix in filename for suffix in valid_band_suffixes) and year in filename:
            band_paths.append(os.path.join(cropped_folder, filename))
    
    return band_paths



def combine_and_save_bands(cropped_folder, output_folder, year):
    # Find the paths of the bands for the given year
    band_paths = find_band_paths(cropped_folder, year)

    # Read the bands into numpy arrays
    bands = [rasterio.open(band_path).read(1) for band_path in band_paths]

    # Combine the bands into a single array
    combined_image = np.stack(bands, axis=0)

    # Normalize the image to [0, 255]
    combined_image = (combined_image / 65535.0 * 255).astype(np.uint8)

    # Transpose to switch the axis order to (height, width, channels)
    combined_image = np.transpose(combined_image, (1, 2, 0))

    # Save the combined image as a PNG file
    output_path = os.path.join(output_folder, f"{year}_combined.png")
    Image.fromarray(combined_image).save(output_path)

    print(f"Combined image for {year} saved successfully at: {output_path}")

# Example usage
cropped_folder = "data/cropped_combined"
output_folder = "data/combined_output"

# List of years for which you want to combine the bands
years_to_process = ["2021", "2022", "2023", "2024"]

# Combine and save bands for each year
for year in years_to_process:
    combine_and_save_bands(cropped_folder, output_folder, year)
